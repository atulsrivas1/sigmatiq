# Custom Model Builder (UI Plan)

This document describes how the UI will let users assemble a custom model by choosing assets, horizon/cadence, 0DTE flow features (for options), and technical indicators. It maps each UI step to existing backend behavior and a few small API additions.

## Goals
- Compose models from a curated set of features and indicators without editing files.
- Keep models reproducible (per-model config + policy files saved under a pack).
- Provide a fast preview to validate config and data availability before running a full pipeline.

## User Flow (Wizard)

1) Basics
- Inputs: `ticker`, `asset_type` (`opt` or `eq`), `horizon` (`0dte`|`intraday`|`swing`|`long`), `cadence` (`hourly`|`5m`|`daily`).
- Preview `model_id`: auto-generated as `<ticker>_<asset>_<horizon>_<cadence>[_<algo>|_<variant>]`.
- Backend: name generator from `scripts/create_model.py` (also see `products/sigma-lab/docs/model_naming.md`).

2) Options Flow Families (opt-only)
- Toggles: per-distance (`calls_sold_d*`, `puts_sold_d*`), totals/ratios, ATM, OI; set `distance_max`.
- Backend: build_matrix drives generation via `FeatureBuilder`; train honors toggles under `features.flow/*` in the model config.

3) Technical Indicators (Bars + IV)
- Browse indicators via categories (GET `/indicators?group=true`).
- Select indicators; set parameters (e.g., EMA window, MACD fast/slow/signal, Bollinger window/num_std, daily RSI/EMA/RET, composite, ATR/OBV, ADX, IV metrics).
- IV metrics: choose IV source (`snapshot`|`quotes`|`auto`); set quote time window (e.g., `14:30-15:00`) if using quotes; set term slope horizon (e.g., 30 days).
- Backend: pack’s `indicator_set.yaml` drives build_matrix; the UI writes this file (per-pack or per-model override).

4) Train/Backtest Settings
- Allowed ET hours, thresholds or top% selection (with min trades), momentum gate (`momentum_min`, `momentum_column`), optional calibration.
- Backend: policy YAML validated by `/validate_policy`; backtest reads execution fields (e.g., momentum gate) and settings from request.

5) Validate & Preview
- Short 1–2 day preview build (fast) to ensure:
  - Indicators produce columns (non-empty)
  - Flow features present when enabled
  - IV metrics populated (or clearly NaN/unavailable)
- Backend: POST `/preview_matrix` runs `build_matrix` over a short window and returns column list + NaN stats.

6) Save & Run
- UI saves `packs/<pack_id>/model_configs/<model_id>.yaml`, `packs/<pack_id>/policy_templates/<model_id>.yaml`, and (optionally) a `packs/<pack_id>/indicator_sets/<model_id>.yaml` override.
- Orchestrate full pipeline: build → train → backtest; stream progress; link to plots and leaderboard entries.
- Backend: existing POST `/build_matrix`, `/train`, `/backtest`; plots under `products/sigma-lab/static/backtest_plots/<model_id>/`; DB persistence for leaderboard.

## Backend Mapping (What Exists vs. What’s Needed)

- Exists
  - GET `/indicators`, `/indicators?group=true`: browsable registry with params and docs.
  - Pack-driven build: `indicator_set.yaml` controls which indicators compute; flow features generated by `FeatureBuilder`.
  - Train/backtest selection: `select_features(df)` plus per-model toggles include flow families and bar-based indicators.
  - Policy validation & enforcement: GET `/validate_policy`, backtests enforce presence & momentum gate.
  - Leaderboard persistence: POST `/backtest` saves runs and folds; GET `/leaderboard` lists top runs.
  - Model creation scripting: `scripts/create_model.py` auto-generates `model_id`, ensures policy & config.

- Needed (small)
  - POST `/models` (create): call the create script logic to generate `model_id`, write model_config and policy, and ensure directories.
  - POST `/indicator_sets` (create/update): accept a JSON list of indicators with params and write pack/per-model indicator set YAML.
  - POST `/preview_matrix`: run a short build and return column list + NaN stats for UI validation.
  - (Optional) Enrich `/indicators` with example params, default values, and provider hints from `products/sigma-lab/docs/indicators/REFERENCE.md` and the MD catalog import.

## Selection & Control Details

- Flow features (0DTE): controlled in model config under `features.flow.*`; train only includes columns present in the CSV and toggled true.
- Technical indicators: computed if present in the indicator set; `select_features(df)` will be updated to include common prefixes (bb_, macd_, plus_di_/minus_di_/adx_, atr_, obv, rsi_, daily_* `_d`, vwap_d, iv_*). Optionally allow per-model `features.custom.include/exclude` for precision.
- IV metrics: return NaN (not 0) when unavailable; IV source controls allow testing with historical quotes as a fallback (heavier).

## Files & Paths
- Model config: `products/sigma-lab/packs/<pack_id>/model_configs/<model_id>.yaml`
- Policy: `products/sigma-lab/packs/<pack_id>/policy_templates/<model_id>.yaml` (mandatory; validated via API)
- Indicator set: `products/sigma-lab/packs/<pack_id>/indicator_set.yaml` (global) or per-model override
- Matrices: `products/sigma-lab/matrices/<model_id>/...`
- Artifacts (trained model): `products/sigma-lab/artifacts/<model_id>/gbm.pkl`
- Plots: `products/sigma-lab/static/backtest_plots/<model_id>/cum_returns.png`
- Backtests DB: `backtest_runs`, `backtest_folds` (see migrations)

## Example: Per-Model Indicator Set (YAML)
```yaml
# products/sigma-lab/packs/zeroedge/indicator_sets/spy_opt_0dte_hourly_xgb.yaml
name: zeroedge_custom
version: 1
indicators:
  - name: ema
    window: 20
    column: close
  - name: macd
    fast: 12
    slow: 26
    signal: 9
  - name: bollinger_bands
    window: 20
    num_std: 2.0
  - name: adx
    period: 14
  - name: daily_rsi
    period: 14
    underlying: SPY
  - name: iv_realized_spread
    window: 20
    underlying: SPY
```

## Example: Model Config (Flow + Toggles)
```yaml
model_id: spy_opt_0dte_hourly_xgb
ticker: SPY
asset_type: opt
features:
  flow:
    per_distance: true
    totals: true
    ratios: true
    atm: false
  dealer:
    mm_profit_dir_simple: true
    divergence_score: true
  oi:
    include: false
  time:
    day_of_week: true
momentum:
  include: true
  hourly_horizons: [1, 3]
volatility:
  include: true
  hourly_horizons: [3]
```

## Example: Policy (Execution + Momentum Gate)
```yaml
name: zeroedge_default_v1
version: 1
policy:
  risk:
    max_drawdown: 0.1
    max_exposure: 10000
  execution:
    slippage_bps: 1.0
    size_by_conf: false
    conf_cap: 1.0
    momentum_gate: false
    momentum_min: 0.0
    momentum_column: momentum_score_total
  alerting:
    cooldown_minutes: 5
    max_trades_per_day: 10
```

## Quick Links
- Model naming: `products/sigma-lab/docs/model_naming.md`
- Indicator reference: `products/sigma-lab/docs/indicators/REFERENCE.md`
- Policy schema: `products/sigma-lab/docs/policy_schema.md`
- Status & plans: `products/sigma-lab/docs/STATUS_AND_PLANS.md`

***

With these pieces, the UI can let users assemble custom models confidently, preview them quickly, and run pipelines — while keeping everything reproducible in versioned configs and policies.
